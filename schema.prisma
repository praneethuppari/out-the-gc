datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Use Prisma Schema file to define your entities: https://www.prisma.io/docs/concepts/components/prisma-schema.
// Run `wasp db migrate-dev` in the CLI to create the database tables,
// then run `wasp db studio` to open Prisma Studio and view your db models.

model User {
  id       String @id @default(uuid())
  username String

  // Trip relationships
  tripsAsOrganizer Trip[] @relation("TripOrganizer")
  tripParticipants TripParticipant[]
  datePitches      DatePitch[]
  dateVotes        DateVote[]
  destinationPitches DestinationPitch[]
  destinationVotes   DestinationVote[]
  travelConfirmations TravelConfirmation[]
  activities         Activity[]
}

// Note: SQLite doesn't support enums, so we use String types instead
// Valid values: "GOING", "INTERESTED", "NOT_GOING"
// Valid values: "ORGANIZER", "PARTICIPANT"
// Valid values: "DATES", "DESTINATION", "TRAVEL_CONFIRMATION", "COMPLETED"

model Trip {
  id          String   @id @default(uuid())
  title       String
  description String?
  coverPhoto  String?
  joinToken   String   @unique // For shareable join links
  phase       String   @default("DATES") // PlanningPhase: DATES, DESTINATION, TRAVEL_CONFIRMATION, COMPLETED
  datePitchDeadline DateTime? // Deadline for submitting date proposals (set by organizer)
  votingDeadlineDurationDays Int @default(7) // Days after pitch deadline for voting (default 1 week)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizer   User   @relation("TripOrganizer", fields: [organizerId], references: [id])
  organizerId String

  participants TripParticipant[]
  datePitches  DatePitch[]
  destinationPitches DestinationPitch[]
  travelConfirmations TravelConfirmation[]
  activities Activity[]
}

model TripParticipant {
  id        String     @id @default(uuid())
  rsvpStatus String    @default("INTERESTED") // RSVPStatus: GOING, INTERESTED, NOT_GOING
  role      String     @default("PARTICIPANT") // TripRole: ORGANIZER, PARTICIPANT
  joinedAt  DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)
  tripId String

  user   User   @relation(fields: [userId], references: [id])
  userId String

  @@unique([tripId, userId])
  @@index([tripId])
  @@index([userId])
}

model DatePitch {
  id          String   @id @default(uuid())
  startDate   DateTime
  endDate     DateTime
  description String?
  pitchDeadline DateTime // Deadline for submitting pitches
  votingDeadline DateTime // Deadline for voting
  createdAt   DateTime @default(now())

  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)
  tripId String

  pitchedBy   User   @relation(fields: [pitchedById], references: [id])
  pitchedById String

  votes DateVote[]
}

model DateVote {
  id        String   @id @default(uuid())
  voteType  String   // "ALL_WORK", "PARTIAL", "NONE_WORK"
  selectedDates String? // JSON array of dates for PARTIAL votes
  createdAt DateTime @default(now())

  pitch   DatePitch @relation(fields: [pitchId], references: [id], onDelete: Cascade)
  pitchId String

  user   User   @relation(fields: [userId], references: [id])
  userId String

  @@unique([pitchId, userId])
  @@index([pitchId])
}

model DestinationPitch {
  id          String   @id @default(uuid())
  location    String
  description String
  createdAt   DateTime @default(now())

  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)
  tripId String

  pitchedBy   User   @relation(fields: [pitchedById], references: [id])
  pitchedById String

  votes DestinationVote[]
}

model DestinationVote {
  id        String   @id @default(uuid())
  ranking   Int      // Rank order (1 = first choice, 2 = second, etc.)
  createdAt DateTime @default(now())

  pitch   DestinationPitch @relation(fields: [pitchId], references: [id], onDelete: Cascade)
  pitchId String

  user   User   @relation(fields: [userId], references: [id])
  userId String

  @@unique([pitchId, userId])
  @@index([pitchId])
}

model TravelConfirmation {
  id        String   @id @default(uuid())
  isBooked  Boolean  @default(false)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)
  tripId String

  user   User   @relation(fields: [userId], references: [id])
  userId String

  @@unique([tripId, userId])
  @@index([tripId])
}

// ActivityType enum values: TRIP_CREATED, USER_JOINED, RSVP_CHANGED, DATE_PITCH_CREATED,
// DATE_VOTE_CAST, DESTINATION_PITCH_CREATED, DESTINATION_VOTE_CAST, PHASE_CHANGED, TRAVEL_CONFIRMED

model Activity {
  id        String       @id @default(uuid())
  type      String       // ActivityType: TRIP_CREATED, USER_JOINED, RSVP_CHANGED, etc.
  metadata  String?      // JSON for additional context
  createdAt DateTime     @default(now())

  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)
  tripId String

  user   User   @relation(fields: [userId], references: [id])
  userId String

  @@index([tripId])
  @@index([createdAt])
}
